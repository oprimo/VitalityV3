local Tunnel = module("vrp","lib/Tunnel")
local Proxy = module("vrp","lib/Proxy")
vRP = Proxy.getInterface("vRP")
vRPserver = Tunnel.getInterface("vRP")
emP = Tunnel.getInterface("vitality_corrida")
-----------------------------------------------------------------------------------------------------------------------------------------
-- VARIAVEIS
-----------------------------------------------------------------------------------------------------------------------------------------
local blips = false
local inrace = false
local timerace = 0
local timerecord = 0
local racepoint = 1
local racepos = 0
local CoordenadaX = 1138.40
local CoordenadaY = 65.75
local CoordenadaZ = 80.75
local PlateIndex = nil
local bomba = nil
local explosive = 0
-- 1138.40,65.75,80.75
-----------------------------------------------------------------------------------------------------------------------------------------
-- VARIAVEIS
-----------------------------------------------------------------------------------------------------------------------------------------
local races = {
	[1] = {
		['time'] = 170,
		[1] = { ['x'] = 1083.17, ['y'] = -15.61, ['z'] = 80.75 },
		[2] = { ['x'] = 948.62, ['y'] = -62.96, ['z'] = 77.56 },
		[3] = { ['x'] = 874.01, ['y'] = 24.25, ['z'] = 78.78 },
		[4] = { ['x'] = 1054.43, ['y'] = 257.55, ['z'] = 84.91 },
		[5] = { ['x'] = 1095.09, ['y'] = 425.07, ['z'] = 91.51 },
		[6] = { ['x'] = 896.93, ['y'] = 424.78, ['z'] = 119.42 },
		[7] = { ['x'] = 620.77, ['y'] = 314.63, ['z'] = 107.40 },
		[8] = { ['x'] = 752.56, ['y'] = 175.37, ['z'] = 82.72 },
		[9] = { ['x'] = 585.21, ['y'] = 64.96, ['z'] = 93.73 },
		[10] = { ['x'] = 418.90, ['y'] = -80.81, ['z'] = 70.07 },
		[11] = { ['x'] = 51.67, ['y'] = 0.17, ['z'] = 69.41 },
		[12] = { ['x'] = -113.11, ['y'] = -221.28, ['z'] = 44.82 },
		[13] = { ['x'] = -262.07, ['y'] = -654.29, ['z'] = 33.17 },
		[14] = { ['x'] = 72.64, ['y'] = -790.30, ['z'] = 31.49 },
		[15] = { ['x'] = 75.77, ['y'] = -1053.56, ['z'] = 29.60 },
		[16] = { ['x'] = 81.75, ['y'] = -1339.39, ['z'] = 29.18 },
		[17] = { ['x'] = 145.66, ['y'] = -1331.10, ['z'] = 29.30 }
	},
	[2] = {
		['time'] = 190,
		[1] = { ['x'] = 1083.17, ['y'] = -15.61, ['z'] = 80.75 },
		[2] = { ['x'] = 948.62, ['y'] = -62.96, ['z'] = 77.56 },
		[3] = { ['x'] = 874.01, ['y'] = 24.25, ['z'] = 78.78 },
		[4] = { ['x'] = 801.28, ['y'] = -47.20, ['z'] = 80.64 },
		[5] = { ['x'] = 719.17, ['y'] = 40.79, ['z'] = 84.03 },
		[6] = { ['x'] = 1026.57, ['y'] = 482.22, ['z'] = 95.86 },
		[7] = { ['x'] = 1033.40, ['y'] = 362.22, ['z'] = 90.05 },
		[8] = { ['x'] = 664.943, ['y'] = -185.59, ['z'] = 46.17 },
		[9] = { ['x'] = 519.95, ['y'] = -360.67, ['z'] = 43.34 },
		[10] = { ['x'] = 612.46, ['y'] = -776.05, ['z'] = 11.17 },
		[11] = { ['x'] = 678.32, ['y'] = -854.90, ['z'] = 15.96 },
		[12] = { ['x'] = 779.11, ['y'] = -718.93, ['z'] = 28.12 },
		[13] = { ['x'] = 909.56, ['y'] = -820.73, ['z'] = 43.52 },
		[14] = { ['x'] = 523.91, ['y'] = -847.21, ['z'] = 40.10 },
		[15] = { ['x'] = 224.48, ['y'] = -826.21, ['z'] = 30.19 },
		[16] = { ['x'] = 128.71043395996, ['y'] = -906.19311523438, ['z'] = 29.973573684692 },
		[17] = { ['x'] = 33.817100524902, ['y'] = -962.09796142578, ['z'] = 29.208206176758 },
		[18] = { ['x'] = 59.364360809326, ['y'] = -887.44439697266, ['z'] = 30.054788589478 },
		[19] = { ['x'] = 39.93611907959, ['y'] = -869.26770019531, ['z'] = 30.314952850342 },
		[20] = { ['x'] = 27.489347457886, ['y'] = -828.06469726563, ['z'] = 30.848073959351 },
		[21] = { ['x'] = 71.011940002441, ['y'] = -694.91455078125, ['z'] = 31.574937820435 },
		[22] = { ['x'] = 178.04847717285, ['y'] = -722.16821289063, ['z'] = 33.221466064453 },
		[23] = { ['x'] = 166.15103149414, ['y'] = -805.806640625, ['z'] = 30.967998504639 },
		[24] = { ['x'] = -346.73126220703, ['y'] = -667.41052246094, ['z'] = 31.814653396606 },
		[25] = { ['x'] = -349.50366210938, ['y'] = -753.56866455078, ['z'] = 33.99979019165 }
	},
	[3] = {
		['time'] = 160,
		[1] = { ['x'] = 1083.17, ['y'] = -15.61, ['z'] = 80.75 },
		[2] = { ['x'] = 948.62, ['y'] = -62.96, ['z'] = 77.56 },
		[3] = { ['x'] = 874.01, ['y'] = 24.25, ['z'] = 78.78 },
		[4] = { ['x'] = 782.08563232422, ['y'] = -37.8118019104, ['z'] = 80.789237976074 },
		[5] = { ['x'] = 632.77185058594, ['y'] = -45.427959442139, ['z'] = 77.706214904785 },
		[6] = { ['x'] = 425.69067382813, ['y'] = -135.3404083252, ['z'] = 64.932502746582 },
		[7] = { ['x'] = 261.91250610352, ['y'] = -114.88858795166, ['z'] = 69.092674255371 },
		[8] = { ['x'] = 185.21914672852, ['y'] = -328.04949951172, ['z'] = 43.833248138428 },
		[9] = { ['x'] = -105.8729019165, ['y'] = -225.59696960449, ['z'] = 44.676280975342 },
		[10] = { ['x'] = -233.12446594238, ['y'] = -212.6558380127, ['z'] = 49.145305633545 },
		[11] = { ['x'] = -364.68655395508, ['y'] = -202.85525512695, ['z'] = 37.064575195313 },
		[12] = { ['x'] = -614.14337158203, ['y'] = -322.06396484375, ['z'] = 34.709857940674 },
		[13] = { ['x'] = -719.96466064453, ['y'] = -293.05590820313, ['z'] = 36.779956817627 },
		[14] = { ['x'] = -776.99578857422, ['y'] = -257.4391784668, ['z'] = 37.005779266357 },
		[15] = { ['x'] = -873.72576904297, ['y'] = -209.77632141113, ['z'] = 39.097961425781 },
		[16] = { ['x'] = -962.63214111328, ['y'] = -205.77606201172, ['z'] = 37.592681884766 },
		[17] = { ['x'] = -1082.5032958984, ['y'] = -269.57754516602, ['z'] = 37.494731903076 },
		[18] = { ['x'] = -1263.8527832031, ['y'] = -317.84539794922, ['z'] = 36.995960235596 },
		[19] = { ['x'] = -1503.4886474609, ['y'] = -456.25030517578, ['z'] = 35.652545928955 },
		[20] = { ['x'] = -1533.5012207031, ['y'] = -438.01696777344, ['z'] = 35.258571624756 },
		[21] = { ['x'] = -1521.1761474609, ['y'] = -422.58114624023, ['z'] = 35.273548126221 },
		[22] = { ['x'] = -1516.4716796875, ['y'] = -449.48361206055, ['z'] = 35.256778717041 },
		[23] = { ['x'] = -1639.2069091797, ['y'] = -556.26025390625, ['z'] = 33.541931152344 },
		[24] = { ['x'] = -1551.6636962891, ['y'] = -667.73864746094, ['z'] = 28.931261062622 },
		[25] = { ['x'] = -1400.2149658203, ['y'] = -578.89019775391, ['z'] = 30.260272979736 },
		[26] = { ['x'] = -1323.0500488281, ['y'] = -653.31988525391, ['z'] = 26.321390151978 },
		[27] = { ['x'] = -1237.1315917969, ['y'] = -604.68432617188, ['z'] = 26.993518829346 },
		[28] = { ['x'] = -1123.2777099609, ['y'] = -515.54766845703, ['z'] = 34.260219573975 },
		[29] = { ['x'] = -978.22943115234, ['y'] = -444.70190429688, ['z'] = 37.639057159424 },
		[30] = { ['x'] = -936.59259033203, ['y'] = -484.46102905273, ['z'] = 36.89949798584 },
		[31] = { ['x'] = -830.66790771484, ['y'] = -439.92202758789, ['z'] = 36.472831726074 }
	},
	[4] = {
		['time'] = 190,
		[1] = { ['x'] = 1083.17, ['y'] = -15.61, ['z'] = 80.75 },
		[2] = { ['x'] = 948.62, ['y'] = -62.96, ['z'] = 77.56 },
		[3] = { ['x'] = 874.01, ['y'] = 24.25, ['z'] = 78.78 },
		[4] = { ['x'] = 970.72796630859, ['y'] = 154.29205322266, ['z'] = 81.007469177246 },
		[5] = { ['x'] = 1152.4774169922, ['y'] = 307.68743896484, ['z'] = 91.126594543457 },
		[6] = { ['x'] = 1244.7158203125, ['y'] = 512.87158203125, ['z'] = 80.96361541748 },
		[7] = { ['x'] = 1621.1994628906, ['y'] = 1093.1647949219, ['z'] = 81.657814025879 },
		[8] = { ['x'] = 1580.0609130859, ['y'] = 1300.3641357422, ['z'] = 91.705459594727 },
		[9] = { ['x'] = 1500.8154296875, ['y'] = 1743.544921875, ['z'] = 108.96350097656 },
		[10] = { ['x'] = 1490.6237792969, ['y'] = 2168.1032714844, ['z'] = 85.366905212402 },
		[11] = { ['x'] = 1395.7891845703, ['y'] = 2548.4653320313, ['z'] = 40.091728210449 },
		[12] = { ['x'] = 1040.0511474609, ['y'] = 2688.9672851563, ['z'] = 39.397598266602 },
		[13] = { ['x'] = 755.53729248047, ['y'] = 2699.5844726563, ['z'] = 39.949611663818 },
		[14] = { ['x'] = 642.59844970703, ['y'] = 2592.2001953125, ['z'] = 53.923004150391 },
		[15] = { ['x'] = 734.13775634766, ['y'] = 2421.8637695313, ['z'] = 60.023918151855 },
		[16] = { ['x'] = 680.67388916016, ['y'] = 2291.6447753906, ['z'] = 50.908821105957 },
		[17] = { ['x'] = 1124.1042480469, ['y'] = 1889.7971191406, ['z'] = 65.496910095215 },
		[18] = { ['x'] = 1304.8070068359, ['y'] = 1055.6416015625, ['z'] = 105.55381011963 },
		[19] = { ['x'] = 1026.5903320313, ['y'] = 490.91723632813, ['z'] = 96.429847717285 },
		[20] = { ['x'] = 916.55627441406, ['y'] = 527.67016601563, ['z'] = 120.20649719238 },
		[21] = { ['x'] = 603.12585449219, ['y'] = 629.34716796875, ['z'] = 128.72415161133 }
	},
	[5] = {
		['time'] = 195,
		[1] = { ['x'] = 1083.17, ['y'] = -15.61, ['z'] = 80.75 },
		[2] = { ['x'] = 948.62, ['y'] = -62.96, ['z'] = 77.56 },
		[3] = { ['x'] = 874.01, ['y'] = 24.25, ['z'] = 78.78 },
		[4] = { ['x'] = 804.19476318359, ['y'] = -43.918617248535, ['z'] = 80.691963195801 },
		[5] = { ['x'] = 863.30541992188, ['y'] = -104.9193572998, ['z'] = 79.307914733887 },
		[6] = { ['x'] = 818.71112060547, ['y'] = -186.42726135254, ['z'] = 72.655586242676 },
		[7] = { ['x'] = 625.30389404297, ['y'] = -66.589797973633, ['z'] = 74.544212341309 },
		[8] = { ['x'] = 501.59194946289, ['y'] = -176.71797180176, ['z'] = 53.872653961182 },
		[9] = { ['x'] = 471.0012512207, ['y'] = -304.24066162109, ['z'] = 47.163105010986 },
		[10] = { ['x'] = 334.39059448242, ['y'] = -387.79119873047, ['z'] = 45.109092712402 },
		[11] = { ['x'] = 32.639114379883, ['y'] = -275.29006958008, ['z'] = 47.490386962891 },
		[12] = { ['x'] = -53.284206390381, ['y'] = -490.74145507813, ['z'] = 40.309707641602 },
		[13] = { ['x'] = -190.80972290039, ['y'] = -880.79064941406, ['z'] = 29.209573745728 },
		[14] = { ['x'] = -351.15478515625, ['y'] = -837.39044189453, ['z'] = 31.44458770752 },
		[15] = { ['x'] = -348.68173217773, ['y'] = -784.46606445313, ['z'] = 33.79118347168 },
		[16] = { ['x'] = -340.08587646484, ['y'] = -816.55987548828, ['z'] = 36.222023010254 },
		[17] = { ['x'] = -346.68975830078, ['y'] = -787.60131835938, ['z'] = 38.613910675049 },
		[18] = { ['x'] = -348.35845947266, ['y'] = -819.00451660156, ['z'] = 41.040588378906 },
		[19] = { ['x'] = -346.93569946289, ['y'] = -785.4228515625, ['z'] = 43.426124572754 },
		[20] = { ['x'] = -346.40432739258, ['y'] = -820.09741210938, ['z'] = 45.857189178467 },
		[21] = { ['x'] = -348.57623291016, ['y'] = -786.07244873047, ['z'] = 48.272113800049 },
		[22] = { ['x'] = -346.72372436523, ['y'] = -820.06744384766, ['z'] = 50.700584411621 },
		[23] = { ['x'] = -331.10464477539, ['y'] = -770.73907470703, ['z'] = 53.071620941162 },
		[24] = { ['x'] = -271.26315307617, ['y'] = -770.33929443359, ['z'] = 56.316413879395 },
		[25] = { ['x'] = -227.5375213623, ['y'] = -690.63653564453, ['z'] = 33.263236999512 },
		[26] = { ['x'] = -308.99554443359, ['y'] = -657.69482421875, ['z'] = 32.903762817383 },
		[27] = { ['x'] = -303.75680541992, ['y'] = -624.70806884766, ['z'] = 33.261615753174 },
		[28] = { ['x'] = 25.896583557129, ['y'] = -663.78228759766, ['z'] = 31.471702575684 },
		[29] = { ['x'] = 23.979114532471, ['y'] = -578.01831054688, ['z'] = 31.449192047119 }
	}
}
-----------------------------------------------------------------------------------------------------------------------------------------
-- STARTRACES
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		local kswait = 1000
		if not inrace then
			local ped = PlayerPedId()
			local vehicle = GetVehiclePedIsUsing(ped)
			local x,y,z = table.unpack(GetEntityCoords(ped))
			local bowz,cdz = GetGroundZFor_3dCoord(CoordenadaX,CoordenadaY,CoordenadaZ)
			local distance = GetDistanceBetweenCoords(CoordenadaX,CoordenadaY,cdz,x,y,z,true)

			if distance <= 30.0 then
				
				if IsEntityAVehicle(vehicle) and GetVehicleClass(vehicle) ~= 8 and GetPedInVehicleSeat(vehicle,-1) == ped then
					kswait = 4	
					--DrawMarker(27,CoordenadaX,CoordenadaY,CoordenadaZ-0.96,0,0,0,0,0,0,10.0,10.0,1.0,148,27,150,50,0,0,0,0)
					if distance <= 30.0 then
						drawTxt("PRESSIONE  ~r~E~w~  PARA INICIAR A CORRIDA",4,0.5,0.93,0.50,255,255,255,180)
						if IsControlJustPressed(0,38) and emP.checkPermission() then
							--if emP.checkTicket() then
								if emP.checkTimer() then
									emP.setSearchTimer()
									inrace = true
									racepos = 1
									racepoint = emP.getRacepoint()
									timerace = races[racepoint].time
									timerecord = 0
									PlateIndex = GetVehicleNumberPlateText(vehicle)
									SetVehicleNumberPlateText(vehicle,"CORREDOR")
									CriandoBlip(races,racepoint,racepos)
									explosive = math.random(100)
									if explosive >= 1 then
										emP.startBombRace()
										bomba = CreateObject(GetHashKey("prop_c4_final_green"),x,y,z,true,true,true)
										AttachEntityToEntity(bomba,vehicle,GetEntityBoneIndexByName(vehicle,"exhaust"),0.0,0.0,0.0,180.0,-90.0,180.0,false,false,false,true,2,true)
										PlaySoundFrontend(-1,"Oneshot_Final","MP_MISSION_COUNTDOWN_SOUNDSET",false)
										TriggerEvent("Notify","importante","Importante","Você iniciou uma corrida <b>ilegal</b>, não saia do veículo e termine no tempo estimado.",8000)
									end
								end
							end
						--end
					end
				end
			end
		end
		Citizen.Wait(kswait)
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- CHECKPOINTS
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		local kswait = 500
		if inrace then
			kswait = 4
			local ped = PlayerPedId()
			local vehicle = GetVehiclePedIsUsing(ped)
			local x,y,z = table.unpack(GetEntityCoords(ped))
			local bowz,cdz = GetGroundZFor_3dCoord(races[racepoint][racepos].x,races[racepoint][racepos].y,races[racepoint][racepos].z)
			local distance = GetDistanceBetweenCoords(races[racepoint][racepos].x,races[racepoint][racepos].y,cdz,x,y,z,true)

			if distance <= 15.0 then
				if IsEntityAVehicle(vehicle) and GetVehicleClass(vehicle) ~= 8 then
					DrawMarker(1,races[racepoint][racepos].x,races[racepoint][racepos].y,races[racepoint][racepos].z-3,0,0,0,0,0,0,12.0,12.0,8.0,255,255,255,25,0,0,0,0)
					DrawMarker(21,races[racepoint][racepos].x,races[racepoint][racepos].y,races[racepoint][racepos].z+1,0,0,0,0,180.0,130.0,3.0,3.0,2.0,255,0,0,50,1,0,0,1)
					if distance <= 15.1 then
						RemoveBlip(blips)
						if racepos == #races[racepoint] then
							inrace = false
							timerace = 0
							SetVehicleNumberPlateText(GetPlayersLastVehicle(),PlateIndex)
							PlateIndex = nil
							PlaySoundFrontend(-1,"RACE_PLACED","HUD_AWARDS",false)
							DetachEntity(bomba,false,false)
							TriggerServerEvent("trydeleteobj",ObjToNet(bomba))
							emP.removeBombRace()
							emP.paymentCheck(racepoint,1)
							TriggerEvent('Notify', 'importante','Você finalizou a corrida com sucesso!')
						else
							racepos = racepos + 1
							CriandoBlip(races,racepoint,racepos)
						end
						vRP.playSound("Oneshot_Final","MP_MISSION_COUNTDOWN_SOUNDSET")
					end
				end
			end
		end
		Citizen.Wait(kswait)
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- TIMEDRAWN
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		local kswait = 500
		if inrace and timerace > 0 and GetVehiclePedIsUsing(PlayerPedId()) then
			kswait = 4
			drawTxt("RESTAM ~b~"..timerace.." SEGUNDOS ~w~PARA CHEGAR AO DESTINO FINAL DA CORRIDA",4,0.5,0.905,0.45,255,255,255,100)
		end
		Citizen.Wait(kswait)
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- TIMEUP
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		local kswait = 1000
		if inrace and timerace > 0 and GetVehiclePedIsUsing(PlayerPedId()) then
			kswait = 4
			drawTxt("TEMPO: ~g~"..timerecord.." SEGUNDOS ~w~",1,0.5,0.87,0.45,255,255,255,100)			
		end
		Citizen.Wait(kswait)
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- TIMERACE
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		Citizen.Wait(1000)
		if inrace and timerace > 0 then
			timerace = timerace - 1
			if timerace <= 0 or not IsPedInAnyVehicle(PlayerPedId()) then
				inrace = false
				RemoveBlip(blips)
				SetVehicleNumberPlateText(GetPlayersLastVehicle(),PlateIndex)
				PlateIndex = nil
				if explosive >= 1 then
					SetTimeout(3000,function()
						explosive = 0
						DeleteObject(bomba)
						emP.removeBombRace()
						AddExplosion(GetEntityCoords(GetPlayersLastVehicle()),1,1.0,true,true,true)
					end)
				end
			end
		end
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- TIMERECORD
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		Citizen.Wait(1000)
		if inrace and timerace > 0 then
			timerecord = timerecord + 1			
		end
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
--[[ REMOVEBOMB
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNetEvent("emp_race:unbomb")
AddEventHandler("emp_race:unbomb",function()
	inrace = false
	SetVehicleNumberPlateText(GetPlayersLastVehicle(),PlateIndex)
	PlateIndex = nil
	RemoveBlip(blips)
	if explosive >= 1 then
		explosive = 0
		DeleteObject(bomba)
		emP.removeBombRace()
		TriggerEvent("Notify","importante","A <b>Bomba</b> foi desarmada com sucesso.")
	end
end)]]
-----------------------------------------------------------------------------------------------------------------------------------------
-- FUNÇÕES
-----------------------------------------------------------------------------------------------------------------------------------------
function drawTxt(text,font,x,y,scale,r,g,b,a)
	SetTextFont(font)
	SetTextScale(scale,scale)
	SetTextColour(r,g,b,a)
	SetTextOutline()
	SetTextCentre(1)
	SetTextEntry("STRING")
	AddTextComponentString(text)
	DrawText(x,y)
end

function CriandoBlip(races,racepoint,racepos)
	blips = AddBlipForCoord(races[racepoint][racepos].x,races[racepoint][racepos].y,races[racepoint][racepos].z)
	SetBlipSprite(blips,1)
	SetBlipColour(blips,1)
	SetBlipScale(blips,0.4)
	SetBlipAsShortRange(blips,false)
	SetBlipRoute(blips,true)
	BeginTextCommandSetBlipName("STRING")
	AddTextComponentString("Corrida Clandestina")
	EndTextCommandSetBlipName(blips)
end